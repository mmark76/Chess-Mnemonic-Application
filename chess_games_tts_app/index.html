<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chess PGN Audio Player</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.3/chess.min.js"></script>
    <style>
        :root {
            --bg-color: #f4f4f9;
            --container-bg: #ffffff;
            --text-color: #333333;
            --textarea-bg: #ffffff;
            --textarea-text: #000000;
            --settings-bg: #eeeeee;
            --status-bg: #e8f5e9;
            --status-text: #2e7d32;
            --border-color: #cccccc;
        }

        /* Dark Mode Variables */
        body.dark-mode {
            --bg-color: #121212;
            --container-bg: #1e1e1e;
            --text-color: #e0e0e0;
            --textarea-bg: #2d2d2d;
            --textarea-text: #ffffff;
            --settings-bg: #2c2c2c;
            --status-bg: #1b5e20;
            --status-text: #a5d6a7;
            --border-color: #444444;
        }

        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            background-color: var(--bg-color); 
            color: var(--text-color);
            padding: 20px; 
            max-width: 800px; 
            margin: 0 auto; 
            transition: background-color 0.3s, color 0.3s;
        }

        .header-tools {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .container { 
            background: var(--container-bg); 
            padding: 30px; 
            border-radius: 10px; 
            box-shadow: 0 4px 10px rgba(0,0,0,0.2); 
            transition: background 0.3s;
        }

        h1 { text-align: center; margin-bottom: 20px; }

        .theme-toggle {
            background: transparent;
            border: 2px solid var(--text-color);
            color: var(--text-color);
            padding: 5px 15px;
            border-radius: 20px;
            cursor: pointer;
            font-weight: bold;
            font-size: 14px;
        }
        .theme-toggle:hover { opacity: 0.8; }

        textarea { 
            width: 100%; 
            height: 150px; 
            padding: 10px; 
            border: 1px solid var(--border-color); 
            background-color: var(--textarea-bg);
            color: var(--textarea-text);
            border-radius: 5px; 
            font-family: monospace; 
            font-size: 14px; 
            margin-bottom: 15px; 
            box-sizing: border-box; 
        }

        .controls { display: flex; gap: 10px; flex-wrap: wrap; justify-content: center; margin-bottom: 20px; }
        
        button.ctrl-btn { padding: 12px 24px; border: none; border-radius: 5px; cursor: pointer; font-size: 16px; transition: background 0.3s; font-weight: bold; color: white; }
        .btn-play { background-color: #4CAF50; }
        .btn-play:hover { background-color: #45a049; }
        .btn-pause { background-color: #ff9800; }
        .btn-stop { background-color: #f44336; }

        .status { 
            margin-top: 20px; 
            padding: 15px; 
            background: var(--status-bg); 
            color: var(--status-text);
            border-radius: 5px; 
            border-left: 5px solid #4CAF50; 
            font-size: 1.1em; 
            min-height: 20px; 
        }

        .settings { 
            margin-bottom: 20px; 
            padding: 15px; 
            background: var(--settings-bg); 
            border-radius: 5px; 
            display: flex;
            align-items: center;
            gap: 15px;
            flex-wrap: wrap;
        }
        
        label { font-weight: bold; }
        select, input[type="file"] { padding: 5px; background: var(--textarea-bg); color: var(--textarea-text); border: 1px solid var(--border-color); }
        
        #google_translate_element { margin-right: 15px; }
    </style>
</head>
<body>

    <div class="header-tools">
        <div id="google_translate_element"></div>
        <button class="theme-toggle" onclick="toggleTheme()">ğŸŒ“ Light/Dark</button>
    </div>

<div class="container">
    <h1>â™Ÿï¸ Chess PGN Audio Player</h1>
    
    <div class="settings">
        <div>
            <label for="voiceSelect">Voice:</label>
            <select id="voiceSelect"></select>
        </div>
        <div>
            <label for="rateRange">Speed:</label>
            <input type="range" id="rateRange" min="0.5" max="2" value="1" step="0.1">
            <span id="rateValue">1.0x</span>
        </div>
    </div>

    <p>Paste PGN text or upload a file:</p>
    <textarea id="pgnInput" placeholder='[Event "Example"]&#10;1. e4 e5 2. Nf3 Nc6'></textarea>
    <input type="file" id="fileInput" accept=".pgn">
    
    <br><br>

    <div class="controls">
        <button class="ctrl-btn btn-play" onclick="playGame()">â–¶ Play</button>
        <button class="ctrl-btn btn-pause" onclick="pauseGame()">â¸ Pause</button>
        <button class="ctrl-btn btn-stop" onclick="stopGame()">â¹ Stop</button>
    </div>

    <div id="statusBox" class="status">Ready...</div>
</div>

<script type="text/javascript">
    function googleTranslateElementInit() {
      new google.translate.TranslateElement({pageLanguage: 'en', layout: google.translate.TranslateElement.InlineLayout.SIMPLE}, 'google_translate_element');
    }
</script>
<script type="text/javascript" src="https://translate.google.com/translate_a/element.js?cb=googleTranslateElementInit"></script>

<script>
    let synth = window.speechSynthesis;
    let voices = [];
    let game;
    let isPaused = false;

    // ÎˆÎ»ÎµÎ³Ï‡Î¿Ï‚ Î±Î½ Ï†Î¿ÏÏ„ÏÎ¸Î·ÎºÎµ Î· Î²Î¹Î²Î»Î¹Î¿Î¸Î®ÎºÎ· Chess
    try {
        game = new Chess();
    } catch (e) {
        document.getElementById('statusBox').innerText = "âš ï¸ Error: Chess.js library failed to load. Check internet connection.";
        document.getElementById('statusBox').style.color = "red";
    }

    // --- DARK MODE ---
    function toggleTheme() {
        document.body.classList.toggle('dark-mode');
        localStorage.setItem('theme', document.body.classList.contains('dark-mode') ? 'dark' : 'light');
    }
    if(localStorage.getItem('theme') === 'dark') document.body.classList.add('dark-mode');

    // --- AUDIO & VOICES ---
    function populateVoices() {
        voices = synth.getVoices();
        const voiceSelect = document.getElementById('voiceSelect');
        voiceSelect.innerHTML = '';
        
        // Î¤Î±Î¾Î¹Î½ÏŒÎ¼Î·ÏƒÎ· ÎºÎ±Î¹ Ï†Î¹Î»Ï„ÏÎ¬ÏÎ¹ÏƒÎ¼Î±
        voices.sort((a, b) => a.name.localeCompare(b.name));
        
        voices.forEach((voice, index) => {
            const option = document.createElement('option');
            option.textContent = voice.name + ' (' + voice.lang + ')';
            option.value = index;
            // Î•Ï€Î¹Î»Î¿Î³Î® Î‘Î³Î³Î»Î¹ÎºÏÎ½ Ï‰Ï‚ default
            if(voice.lang.includes("en-US") || voice.lang.includes("en-GB")) {
                if (!voiceSelect.value) option.selected = true; // Select first English found
            }
            voiceSelect.appendChild(option);
        });
    }
    
    // Î‘ÏÏ‡Î¹ÎºÎ® ÎºÎ»Î®ÏƒÎ·
    populateVoices();
    
    // Î”Î™ÎŸÎ¡Î˜Î©Î£Î—: Î¤Î¿ Î²Î±ÏƒÎ¹ÎºÏŒ Î»Î¬Î¸Î¿Ï‚ Î®Ï„Î±Î½ ÎµÎ´Ï (synthesis -> speechSynthesis)
    if (speechSynthesis.onvoiceschanged !== undefined) {
        speechSynthesis.onvoiceschanged = populateVoices;
    }

    // --- TRANSLATION LOGIC ---
    function sanToEnglish(san) {
        // ÎšÎ±Î¸Î±ÏÎ¹ÏƒÎ¼ÏŒÏ‚ Î±Ï€ÏŒ ÏƒÏ‡ÏŒÎ»Î¹Î± Î® ÏƒÏÎ¼Î²Î¿Î»Î± Ï€Î¿Ï… Î´ÎµÎ½ Ï…Ï€Î¿ÏƒÏ„Î·ÏÎ¯Î¶Î¿Î½Ï„Î±Î¹
        san = san.replace(/[?!#+]/g, '');

        if (san === "O-O") return "Short Castles";
        if (san === "O-O-O") return "Long Castles";
        
        let desc = "";
        let pieces = {'K': 'King', 'Q': 'Queen', 'R': 'Rook', 'B': 'Bishop', 'N': 'Knight'};
        
        // 1. Piece
        let firstChar = san.charAt(0);
        if (pieces[firstChar]) {
            desc += pieces[firstChar] + " ";
        } else {
            desc += "Pawn ";
        }

        // 2. Action (takes OR moves to)
        if (san.includes('x')) desc += "takes ";
        else desc += "moves to ";

        // 3. Square (Î‘Ï†Î±Î¹ÏÎ¿ÏÎ¼Îµ Ï„Î± Î³ÏÎ¬Î¼Î¼Î±Ï„Î± Ï„Ï‰Î½ ÎºÎ¿Î¼Î¼Î±Ï„Î¹ÏÎ½ Î±Î»Î»Î¬ ÎºÏÎ±Ï„Î¬Î¼Îµ Ï„Î¿ Ï„ÎµÏ„ÏÎ¬Î³Ï‰Î½Î¿)
        // Î ÏÎ¿ÏƒÎ¿Ï‡Î®: Î¤Î¿ 'b' ÏƒÏ„Î¿ 'b4' (Ï€Î¹ÏŒÎ½Î¹) Î´ÎµÎ½ Ï€ÏÎ­Ï€ÎµÎ¹ Î½Î± Î±Ï†Î±Î¹ÏÎµÎ¸ÎµÎ¯, Î±Î»Î»Î¬ Ï„Î¿ 'B' (Î‘Î¾Î¹Ï‰Î¼Î±Ï„Î¹ÎºÏŒÏ‚) Ï€ÏÎ­Ï€ÎµÎ¹.
        let square = san.replace(/[KQRBNx]/g, ""); 
        desc += square;

        // 4. Check/Mate (Î±Ï€ÏŒ Ï„Î¿ Î±ÏÏ‡Î¹ÎºÏŒ string)
        if (san.includes('#')) desc += ", Checkmate!";
        else if (san.includes('+')) desc += ", Check!";
        
        return desc;
    }

    // --- PLAYBACK LOGIC ---
    function playGame() {
        if (!game) return; // Î‘Î½ Î´ÎµÎ½ Î­Ï‡ÎµÎ¹ Ï†Î¿ÏÏ„ÏÏƒÎµÎ¹ Î· Î²Î¹Î²Î»Î¹Î¿Î¸Î®ÎºÎ·
        stopGame(); 
        game.reset();

        const pgn = document.getElementById('pgnInput').value.trim();
        
        if (!pgn) {
            document.getElementById('statusBox').innerText = "âš ï¸ Please paste a PGN first.";
            return;
        }

        const loaded = game.load_pgn(pgn);

        if (!loaded) {
            document.getElementById('statusBox').innerText = "âŒ Invalid PGN format!";
            return;
        }

        const header = game.header();
        const whiteName = header['White'] || 'White';
        const blackName = header['Black'] || 'Black';
        
        speakText(`New game. ${whiteName} versus ${blackName}.`);

        const moves = game.history();
        let moveNumber = 1;

        // Iterate by pairs (White + Black)
        for (let i = 0; i < moves.length; i += 2) {
            
            // 1. Say "Move X"
            speakText(`Move ${moveNumber}.`, `Move ${moveNumber}`);

            // 2. White's Move
            let whiteSan = moves[i];
            let whiteText = sanToEnglish(whiteSan);
            speakText(`White: ${whiteText}`, `White: ${whiteSan}`);

            // 3. Black's Move (if exists)
            if (i + 1 < moves.length) {
                let blackSan = moves[i+1];
                let blackText = sanToEnglish(blackSan);
                speakText(`Black: ${blackText}`, `Black: ${blackSan}`);
            }

            moveNumber++;
        }
        
        let result = header['Result'];
        if(result) speakText("Result: " + result);
    }

    function speakText(text, visualText = null) {
        let utterance = new SpeechSynthesisUtterance(text);
        const voiceSelect = document.getElementById('voiceSelect');
        
        // ÎˆÎ»ÎµÎ³Ï‡Î¿Ï‚ Î±Î½ Ï…Ï€Î¬ÏÏ‡Î¿Ï…Î½ Ï†Ï‰Î½Î­Ï‚
        if (voices.length > 0) {
            const selectedVoice = voices[voiceSelect.value];
            if (selectedVoice) utterance.voice = selectedVoice;
        }
        
        utterance.rate = parseFloat(document.getElementById('rateRange').value);

        // Add a small pause after "Move X"
        if (text.startsWith("Move")) {
            utterance.rate = utterance.rate * 0.9;
        }

        utterance.onstart = function() {
            let display = visualText ? `ğŸ”Š ${visualText}` : `ğŸ”Š ${text}`;
            document.getElementById('statusBox').innerText = display;
        };
        synth.speak(utterance);
    }

    function pauseGame() {
        if (synth.paused) { synth.resume(); isPaused = false; }
        else { synth.pause(); isPaused = true; }
    }

    function stopGame() {
        synth.cancel();
        document.getElementById('statusBox').innerText = "â¹ Stopped.";
    }

    document.getElementById('fileInput').addEventListener('change', function(event) {
        const file = event.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function(e) { document.getElementById('pgnInput').value = e.target.result; };
            reader.readAsText(file);
        }
    });

    document.getElementById('rateRange').addEventListener('input', function(e) {
        document.getElementById('rateValue').innerText = e.target.value + "x";
    });
</script>

</body>
</html>
