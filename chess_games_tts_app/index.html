<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chess PGN Audio Player</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.3/chess.min.js"></script>
    <style>
        :root {
            --bg-color: #f4f4f9;
            --container-bg: #ffffff;
            --text-color: #333333;
            --textarea-bg: #ffffff;
            --textarea-text: #000000;
            --settings-bg: #eeeeee;
            --status-bg: #e8f5e9;
            --status-text: #2e7d32;
            --border-color: #cccccc;
        }

        /* Dark Mode Variables */
        body.dark-mode {
            --bg-color: #121212;
            --container-bg: #1e1e1e;
            --text-color: #e0e0e0;
            --textarea-bg: #2d2d2d;
            --textarea-text: #ffffff;
            --settings-bg: #2c2c2c;
            --status-bg: #1b5e20;
            --status-text: #a5d6a7;
            --border-color: #444444;
        }

        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            background-color: var(--bg-color); 
            color: var(--text-color);
            padding: 20px; 
            max-width: 800px; 
            margin: 0 auto; 
            transition: background-color 0.3s, color 0.3s;
        }

        .header-tools {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .container { 
            background: var(--container-bg); 
            padding: 30px; 
            border-radius: 10px; 
            box-shadow: 0 4px 10px rgba(0,0,0,0.2); 
            transition: background 0.3s;
        }

        h1 { text-align: center; margin-bottom: 20px; }

        .theme-toggle {
            background: transparent;
            border: 2px solid var(--text-color);
            color: var(--text-color);
            padding: 5px 15px;
            border-radius: 20px;
            cursor: pointer;
            font-weight: bold;
            font-size: 14px;
        }
        .theme-toggle:hover { opacity: 0.8; }

        textarea { 
            width: 100%; 
            height: 150px; 
            padding: 10px; 
            border: 1px solid var(--border-color); 
            background-color: var(--textarea-bg);
            color: var(--textarea-text);
            border-radius: 5px; 
            font-family: monospace; 
            font-size: 14px; 
            margin-bottom: 15px; 
            box-sizing: border-box; 
        }

        .controls { display: flex; gap: 10px; flex-wrap: wrap; justify-content: center; margin-bottom: 20px; }
        
        button.ctrl-btn { padding: 12px 24px; border: none; border-radius: 5px; cursor: pointer; font-size: 16px; transition: background 0.3s; font-weight: bold; color: white; }
        .btn-play { background-color: #4CAF50; }
        .btn-play:hover { background-color: #45a049; }
        .btn-pause { background-color: #ff9800; }
        .btn-stop { background-color: #f44336; }

        .status { 
            margin-top: 20px; 
            padding: 15px; 
            background: var(--status-bg); 
            color: var(--status-text);
            border-radius: 5px; 
            border-left: 5px solid #4CAF50; 
            font-size: 1.1em; 
            min-height: 20px; 
        }

        .settings { 
            margin-bottom: 20px; 
            padding: 15px; 
            background: var(--settings-bg); 
            border-radius: 5px; 
            display: flex;
            align-items: center;
            gap: 15px;
            flex-wrap: wrap;
        }
        
        label { font-weight: bold; }
        select, input[type="file"] { padding: 5px; background: var(--textarea-bg); color: var(--textarea-text); border: 1px solid var(--border-color); }
        
        #google_translate_element { margin-right: 15px; }
    </style>
</head>
<body>

    <div class="header-tools">
        <div id="google_translate_element"></div>
        <button class="theme-toggle" onclick="toggleTheme()">üåì Light/Dark</button>
    </div>

<div class="container">
    <h1>‚ôüÔ∏è Chess PGN Audio Player</h1>
    
    <div class="settings">
        <div>
            <label for="voiceSelect">Voice:</label>
            <select id="voiceSelect"></select>
        </div>
        <div>
            <label for="rateRange">Speed:</label>
            <input type="range" id="rateRange" min="0.5" max="2" value="1" step="0.1">
            <span id="rateValue">1.0x</span>
        </div>
    </div>

    <p>Paste PGN text or upload a file:</p>
    <textarea id="pgnInput" placeholder='[Event "Example"] ... 1. e4 e5 ...'></textarea>
    <input type="file" id="fileInput" accept=".pgn">
    
    <br><br>

    <div class="controls">
        <button class="ctrl-btn btn-play" onclick="playGame()">‚ñ∂ Play</button>
        <button class="ctrl-btn btn-pause" onclick="pauseGame()">‚è∏ Pause</button>
        <button class="ctrl-btn btn-stop" onclick="stopGame()">‚èπ Stop</button>
    </div>

    <div id="statusBox" class="status">Ready...</div>
</div>

<script type="text/javascript">
    function googleTranslateElementInit() {
      new google.translate.TranslateElement({pageLanguage: 'en', layout: google.translate.TranslateElement.InlineLayout.SIMPLE}, 'google_translate_element');
    }
</script>
<script type="text/javascript" src="//translate.google.com/translate_a/element.js?cb=googleTranslateElementInit"></script>

<script>
    let synth = window.speechSynthesis;
    let voices = [];
    let game = new Chess();
    let isPaused = false;

    // --- DARK MODE ---
    function toggleTheme() {
        document.body.classList.toggle('dark-mode');
        localStorage.setItem('theme', document.body.classList.contains('dark-mode') ? 'dark' : 'light');
    }
    if(localStorage.getItem('theme') === 'dark') document.body.classList.add('dark-mode');

    // --- AUDIO & VOICES ---
    function populateVoices() {
        voices = synth.getVoices();
        const voiceSelect = document.getElementById('voiceSelect');
        voiceSelect.innerHTML = '';
        voices.sort((a, b) => a.name.localeCompare(b.name));
        voices.forEach((voice, index) => {
            const option = document.createElement('option');
            option.textContent = voice.name + ' (' + voice.lang + ')';
            option.value = index;
            if(voice.lang.includes("en-US") || voice.lang.includes("en-GB")) option.selected = true;
            voiceSelect.appendChild(option);
        });
    }
    populateVoices();
    if (speechSynthesis.onvoiceschanged !== undefined) synthesis.onvoiceschanged = populateVoices;

    // --- TRANSLATION LOGIC ---
    function sanToEnglish(san) {
        if (san === "O-O") return "Short Castles";
        if (san === "O-O-O") return "Long Castles";
        
        let desc = "";
        let pieces = {'K': 'King', 'Q': 'Queen', 'R': 'Rook', 'B': 'Bishop', 'N': 'Knight'};
        
        // 1. Piece
        let firstChar = san.charAt(0);
        if (firstChar === firstChar.toLowerCase()) desc += "Pawn ";
        else if (pieces[firstChar]) desc += pieces[firstChar] + " ";

        // 2. Action (takes OR moves to)
        if (san.includes('x')) desc += "takes ";
        else desc += "moves to "; // ŒïŒîŒ© Œó ŒëŒõŒõŒëŒìŒó Œ†ŒüŒ• ŒñŒóŒ§ŒóŒ£ŒïŒ£

        // 3. Square
        let square = san.replace(/[+#xKQRBN]/g, "");
        desc += square;

        // 4. Check/Mate
        if (san.includes('#')) desc += ", Checkmate!";
        else if (san.includes('+')) desc += ", Check!";
        
        return desc;
    }

    // --- PLAYBACK LOGIC ---
    function playGame() {
        stopGame(); 
        game.reset();

        const pgn = document.getElementById('pgnInput').value;
        const loaded = game.load_pgn(pgn);

        if (!loaded) {
            document.getElementById('statusBox').innerText = "‚ùå Invalid PGN!";
            return;
        }

        const header = game.header();
        const whiteName = header['White'] || 'Unknown';
        const blackName = header['Black'] || 'Unknown';
        
        speakText(`New game. ${whiteName} versus ${blackName}.`);

        const moves = game.history();
        let moveNumber = 1;

        // Iterate by pairs (White + Black)
        for (let i = 0; i < moves.length; i += 2) {
            
            // 1. Say "Move X"
            speakText(`Move ${moveNumber}.`, `Move ${moveNumber}`);

            // 2. White's Move
            let whiteSan = moves[i];
            let whiteText = sanToEnglish(whiteSan);
            speakText(`White: ${whiteText}`, `White: ${whiteSan}`);

            // 3. Black's Move (if exists)
            if (i + 1 < moves.length) {
                let blackSan = moves[i+1];
                let blackText = sanToEnglish(blackSan);
                speakText(`Black: ${blackText}`, `Black: ${blackSan}`);
            }

            moveNumber++;
        }
        
        let result = header['Result'];
        if(result) speakText("Result: " + result);
    }

    function speakText(text, visualText = null) {
        let utterance = new SpeechSynthesisUtterance(text);
        const voiceSelect = document.getElementById('voiceSelect');
        const selectedVoice = voices[voiceSelect.value];
        if (selectedVoice) utterance.voice = selectedVoice;
        utterance.rate = document.getElementById('rateRange').value;

        // Add a small pause after "Move X"
        if (text.startsWith("Move")) {
            utterance.rate = utterance.rate * 0.9; // Slightly slower for the move number
        }

        utterance.onstart = function() {
            let display = visualText ? `üîä ${visualText}` : `üîä ${text}`;
            document.getElementById('statusBox').innerText = display;
        };
        synth.speak(utterance);
    }

    function pauseGame() {
        if (synth.paused) { synth.resume(); isPaused = false; }
        else { synth.pause(); isPaused = true; }
    }

    function stopGame() {
        synth.cancel();
        document.getElementById('statusBox').innerText = "‚èπ Stopped.";
    }

    document.getElementById('fileInput').addEventListener('change', function(event) {
        const file = event.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function(e) { document.getElementById('pgnInput').value = e.target.result; };
            reader.readAsText(file);
        }
    });

    document.getElementById('rateRange').addEventListener('input', function(e) {
        document.getElementById('rateValue').innerText = e.target.value + "x";
    });
</script>

</body>
</html>